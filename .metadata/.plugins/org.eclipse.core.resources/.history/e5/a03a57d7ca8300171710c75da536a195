package com.reciperex.storage.entity;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Savepoint;
import java.sql.Statement;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.apache.commons.dbutils.QueryRunner;
import org.json.simple.parser.JSONParser;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.reciperex.model.Ingredient;
import com.reciperex.model.Instruction;
import com.reciperex.model.Recipe;
import com.reciperex.model.User;
import com.reciperex.storage.service.DatabaseConfig;
import com.reciperex.storage.service.DatabaseManager;
import com.reciperex.storage.service.SQLBuilder;

public class RecipeService {

	DatabaseConfig config = new DatabaseConfig();
	QueryRunner queryRunner = new QueryRunner();
	ObjectMapper mapper = new ObjectMapper();
	JSONParser parser = new JSONParser();
	DatabaseManager manager = new DatabaseManager();
	
	Connection conn = null;
	Statement stmt = null;
	PreparedStatement pstmt = null;
	String sql = null;
	Map<String, String> constraints = new HashMap<String, String>();
	IngredientService ingredientService = new IngredientService();
	InstructionService instructionService = new InstructionService();
	
	public RecipeService(){
		
	}
	
	
	public int insertNewRecipe(Recipe recipe, Integer userId){
		
		Savepoint savepoint;
		String result = null;
		int r = 0;
		
		try {
			conn = manager.getConnection();
			savepoint = conn.setSavepoint();
			try {
				r = insertRecipeEntity(recipe);
				if (r != 0){
					System.out.println("Recipe entity " + recipe.getTitle() + " successfully inserted into database");
				}
				else {
					System.out.println("Unable to complete recipe insert - failed to insert recipe entity");
					throw new SQLException();
				}
				
				recipe.setId(getIdForNewRecipe(recipe));
				
				r = insertRecipeIngredients(recipe);
				if (r != 0){
					System.out.println("Recipe ingredients successfully inserted into database");
				}
				else {
					System.out.println("Unable to complete recipe insert - failed to insert ingredients");
					throw new SQLException();
				}
								
				r = linkIngredientsToRecipe(recipe);
				if (r != 0){
					System.out.println("Recipe ingredients successfully linked in database");
				}
				else {
					System.out.println("Unable to complete recipe insert - failed to link ingredients");
					throw new SQLException();
				}
				
				r = insertRecipeInstructions(recipe);
				if (r != 0){
					System.out.println("Recipe instructions successfully inserted in database");
				}
				else {
					System.out.println("Unable to complete recipe insert - failed to insert instructions");
					throw new SQLException();
				}
				
				
			} catch (SQLException e) {
				System.out.println("Attempting rollback");
				conn.rollback(savepoint);
				e.printStackTrace();
			}
		} catch (SQLException e1) {
			System.out.println("Unable to perform rollback.");
			e1.printStackTrace();
		}
		System.out.println(result);
		return r;
	}


	private Integer getIdForNewRecipe(Recipe recipe) throws SQLException {
		constraints.clear();
		constraints.put("title", SQLBuilder.toSQLString(recipe.getTitle()));
		constraints.put("owner", recipe.getOwner().toString());
		
		sql = "SELECT id FROM recipe WHERE title = \"" + recipe.getTitle() + "\" AND owner = " + recipe.getOwner();
		if (conn.isClosed()){
			conn = manager.getConnection();
		}
		List<Map<String, Object>> idMapList = manager.mapListQuery(conn,  sql);
		Integer id = (Integer) idMapList.get(0).get("id");
		return id;
	}

	
	private int insertRecipeEntity(Recipe recipe) throws SQLException {
		int r;
		// insert Recipe entity
		pstmt = conn.prepareStatement("INSERT INTO recipe (title, description, owner, attributedTo, "
			+ "numberOfServings, ovenTemp, servingSize, cookTime, prepTime) "
			+ "VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?);");
		pstmt.setString(1, recipe.getTitle());
		pstmt.setString(2, recipe.getDescription());
		pstmt.setInt(3, recipe.getOwner());
		pstmt.setString(4, recipe.getAttributedTo());
		pstmt.setInt(5, recipe.getNumberOfServings());
		pstmt.setInt(6, recipe.getOvenTemp());
		pstmt.setString(7, recipe.getServingSize());
		pstmt.setString(8, recipe.getCookTime());
		pstmt.setString(9, recipe.getPrepTime());
		
		r = pstmt.executeUpdate();
		return r;
	}


	private int insertRecipeIngredients(Recipe recipe) throws SQLException {
		boolean allIngredientsExist = true;
		
		constraints.clear();
		
		List<Map<String, Object>> ingredientMapList = ingredientService.queryIngredients(recipe);

		for (String s : recipe.getIngredients().keySet()){
			boolean exists = false;
			for (Map m : ingredientMapList){
				if (s.equals(m.get("name"))){
					exists = true;
					break;
				}
			}
			if (!exists){
				allIngredientsExist = false;
				Ingredient newIngredient = new Ingredient(s, null);
				int insertResult = ingredientService.insertNewIngredient(newIngredient);
				if (insertResult != 1){
					System.out.println("Ingredient " + s + "could not be added to database.");
					throw new SQLException();
				}
			}
		}
		return 1;
	}
	
	private int linkIngredientsToRecipe(Recipe recipe) {
		int result = 0;
		
		try {
		
			List<Map<String, Object>> ingredientMapList = ingredientService.queryIngredients(recipe);
		
			if (conn.isClosed()){
				conn = manager.getConnection();
			}
			Map<String, Integer> ingredientMap = new HashMap<String, Integer>();
			for (Map m : ingredientMapList){
				ingredientMap.put(m.get("name").toString(), Integer.valueOf(m.get("id").toString()));
			}
			
			for (String m : recipe.getIngredients().keySet()){
				
				pstmt = conn.prepareStatement("INSERT INTO ingredient_recipe (recipeId, ingredientId, quantity) VALUES (?, ?, ?)");
				pstmt.setInt(1, recipe.getId());
				pstmt.setInt(2, ingredientMap.get(m));
				pstmt.setString(3, recipe.getIngredients().get(m));
				
				result = pstmt.executeUpdate();
				
				if (result != 1){
					System.out.println("Unable to create link between recipe '" + recipe.getTitle() + " and ingredient '" + m + "'");
				}
			}
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		
		return result;
	}


	private int insertRecipeInstructions(Recipe recipe) throws SQLException {
		constraints.clear();
		
		List<Map<String, Object>> instructionMapList = instructionService.queryInstructions(recipe);
		System.out.println(instructionMapList);

		for (Integer i : recipe.getInstructions().keySet()){

			Instruction newInstruction = new Instruction(i, recipe.getInstructions().get(i), recipe.getId());
			int insertResult = instructionService.insertNewInstruction(newInstruction);
			if (insertResult != 1){
				System.out.println("Instruction " + i + "could not be added to database.");
				throw new SQLException();
			}
		}
		return 1;
	}


	public int deleteRecipe(Integer id){
		int result = -1;
		Map<String,String> constraints = new HashMap<String, String>();
		constraints.put("id", id.toString());
		result = manager.DeleteEntity("recipe", constraints);
		return result;
	}
}
